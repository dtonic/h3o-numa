name: Sync with upstream h3o

on:
  schedule:
    # Run every day at 00:00 UTC
    - cron: "0 0 * * *"
  workflow_dispatch: # Allow manual trigger

jobs:
  sync:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          ref: master
          fetch-depth: 0

      - name: Fetch upstream changes
        run: |
          git remote add upstream https://github.com/HydroniumLabs/h3o.git || true
          git fetch upstream master

      - name: Check for new commits
        id: check
        run: |
          LOCAL=$(git rev-parse master)
          REMOTE=$(git rev-parse upstream/master)
          if [ "$LOCAL" != "$REMOTE" ]; then
          echo "changes=true" >> $GITHUB_OUTPUT
          COMMITS=$(git log --oneline master..upstream/master)
          echo "commits<<EOF" >> $GITHUB_OUTPUT
          echo "$COMMITS" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT
          else
          echo "changes=false" >> $GITHUB_OUTPUT
          fi

      - name: Create Pull Request
        if: steps.check.outputs.changes == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            const { data: pr } = await github.rest.pulls.create({
            owner: context.repo.owner,
            repo: context.repo.repo,
            title: 'ðŸ”„ Sync with upstream h3o',
            head: 'h3o:master',
            head_repo: 'HydroniumLabs/h3o',
            base: 'master',
            body: `## Upstream Sync

            New commits from upstream h3o repository:

            \`\`\`
            ${{ steps.check.outputs.commits }}
            \`\`\`

            ---
            ðŸ¤– Auto-generated by upstream sync workflow`
            });

            // Assign to andrew-dtonic
            await github.rest.issues.addAssignees({
            owner: context.repo.owner,
            repo: context.repo.repo,
            issue_number: pr.number,
            assignees: ['andrew-dtonic']
            });

            // Add labels
            await github.rest.issues.addLabels({
            owner: context.repo.owner,
            repo: context.repo.repo,
            issue_number: pr.number,
            labels: ['sync', 'upstream']
            });

            core.info(`Created PR #${pr.number}`);
